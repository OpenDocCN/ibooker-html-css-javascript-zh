# 前置内容

## 前言

作为一名高中教师和程序员，我处于一个很好的位置来开发支持学校内教学、学习和组织的应用程序。我可以亲眼看到学生、教师和支持人员的需求，并与他们合作构建直观的应用程序和工具，使计划、沟通、理解和娱乐变得更加容易。我开始用 JavaScript 编写测验应用程序和匹配游戏，然后创建了利用 jQuery 和模板的教案规划和资源预订应用程序。然后，科学部门希望有一种订购教学设备的方法，领导团队希望有一种让员工传达公告的方法，而 ICT 技术人员希望有一种让员工报告和管理软件和硬件问题的方法。如何关于一个座位安排应用程序、网站新闻故事的内容管理系统、定制日历、交互式值班表或体育比赛日记，所有这些都具有一致的外观和感觉？

虽然每个项目都有自己的要求，但它们之间有很多重叠，并且可以在各个应用程序中使用类似的方法。为了加快进度，我转向使用 Node.js、Express、Handlebars、Backbone 和 Marionette 进行端到端的 JavaScript 开发。大部分工作都进行得很顺利，尽管在需求变化时进行更新有时会有些麻烦。特别是，模型、视图和控制器之间的数据流并不总是流畅。用户很满意，但我能看到代码中潜在的问题，并知道我迟早需要回到这些问题上，理清其中的曲折。

然后，我遇到了 React，所有问题都得到了解决！好吧，不是完全解决了。但 React 的组件、属性、状态和自动重新渲染的模式以一种之前任何框架都没有的方式触动了我。一个接一个，我将现有的应用程序转换为 React。每次转换，它们都变得更加简单、更容易理解、更容易维护。常见的组件可以重用，我可以快速、有信心地进行更改和添加新功能。虽然我不是一个 React 狂热者（我是一个框架多样性的粉丝），但我确实是一个皈依者，并享受开发体验和用户反馈。

现在有了 React Hooks，我的代码在简洁性方面又迈出了积极的一步。原本分散在类组件生命周期方法中的代码现在可以集中在一起，无论是在函数组件内部还是在外部自定义钩子中。对于特定功能，无论是设置文档标题、访问本地存储、管理上下文值、测量屏幕元素、订阅服务或获取数据，隔离、维护和共享代码都变得容易起来。而且，连接到现有库（如 React Router、Redux、React Query 和 React Spring）的功能也变得更加简单。使用 React Hooks 为我们提供了关于 React 组件的新思考方式，尽管它有一些需要留意的初始问题，但在我看来，这无疑是一个向好的转变。

转向 hooks 是 React 将来工作方式的一个根本性变化的组成部分。并发模式将成为新常态，它将实现时间分片魔法，其中渲染不会阻塞主线程，并且可以立即渲染高优先级更新，如用户输入，即使其他组件的 UI 正在构建。选择性水合将允许 React 在用户交互时及时加载组件代码，而 Suspense API 将让开发者能够更仔细地指定加载状态，在代码和资源加载时。

React 团队专注于构建出色的开发者体验，以便开发者能够构建出色的用户体验。进一步的更改仍在进行中，最佳实践将继续出现，但我希望《React Hooks in Action with Suspense and Concurrent Mode》能让你对现有变化有一个坚实的掌握，并为你准备即将到来的激动人心的进展。

## 致谢

这是我通常会感谢朋友和家人在我在地堡里锁着，疯狂地敲打打字机键盘，创作我的杰作时给予的耐心，而其他人则像往常一样继续生活。但是，由于 2020 年的一些事情，这远非正常生活。因此，我想感谢任何以任何方式使周围人的生活变得更好的人，无论大小，在困难时期。

感谢我的编辑 Helen Stergius，她的耐心和鼓励；写一本书是一个漫长的过程，但在像 Helen 这样优秀的编辑的支持和建议下，这个过程会容易得多。还要感谢 John Guthrie 和 Clive Harber，他们注重细节，提供了诚实、建设性的反馈；他们真的帮助使代码和解释更加清晰和一致。我还要感谢我的生产编辑 Deirdre Hiam、我的校对员 Sharon Wilkey、我的校对员 Keri Hales 和我的审阅编辑 Aleksandar Dragosavljevic´。

致所有审稿人：Annie Taylor Chen、Arnaud Castelltort、Bruno Sonnino、Chunxu Tang、Clive Harber、Daniel Couper、Edin Kapic、Gustavo Filipe Ramos Gomes、Isaac Wong、James Liu、Joe Justesen、Konstantinos Leimonis、Krzysztof Kamyczek、Rob Lacey、Rohit Sharma、Ronald Borman、Ryan Burrows、Ryan Huber、Sairam Sai，您的建议帮助使这本书更加完善。

## 关于这本书

*《React Hooks 实战：使用 Suspense 和并发模式》* 是一本面向经验丰富的 React 开发者的书籍。它介绍了现在已内置到 React 中的 hooks，并展示了如何在开发使用 React 函数组件的应用程序时使用它们，管理组件内和跨组件的状态，以及通过外部 API 同步组件状态。它展示了 hooks 方法在封装和重用、简化组件代码以及为未来的变化做准备方面是多么出色。它还探讨了 React 团队仍在开发的某些更实验性的 Suspense 和并发模式 API。

### 适合阅读这本书的人

如果您之前使用过 React，并想看看 hooks 如何帮助改进您的代码，将组件从基于类的转换为基于函数的，并与 Suspense 和并发模式集成以改善开发者和用户体验，那么这本书将为您指明道路。您应该已经能够使用`create-react-app`创建新应用，并使用 npm（或 Yarn）安装包。代码示例使用了现代 JavaScript 语法和模式，如解构、默认参数、扩展运算符和可选链操作符，因此，尽管它们在首次使用时会有简短的解释，但您对这些用法越熟悉，效果越好。

### 本书组织结构：路线图

*《React Hooks 实战》* 分为两部分，共有 13 章。在 Manning 网站上这本书的页面还包括一些文章，提供了额外的示例和解释，这些内容没有包含在书籍的主流程中。

第一部分介绍了新、稳定、非实验性的内置 React Hooks 的语法和使用方法。它还展示了如何创建自定义 hooks 并充分利用现有 React 库提供的第三方 hooks：

+   我们从第一章开始，概述了 React 最近的和即将到来的变化，特别关注 React Hooks 如何帮助您组织、维护和共享组件代码。

+   第二章介绍了我们的第一个 hook，`useState`。组件可以使用它来管理状态值，并在值发生变化时触发重新渲染。

+   有时多个状态值相互关联，一个值的变化会导致其他值的变化。第三章中介绍的`useReducer` hook 提供了一种在单个位置管理多个状态变化的方法。

+   React 旨在保持 UI 与你的应用状态同步。有时你的应用需要从其他地方检索状态或在外部显示，例如在浏览器标题中。当你的应用通过访问其组件外部执行副作用时，你应该使用第四章中讨论的`useEffect`钩子来包裹代码，以保持所有部分同步。

+   第五章使用`useRef`钩子在不引起重新渲染（例如，在处理定时器 ID 时）的情况下更新状态，并保持对页面元素（如表单中的文本框）的引用。

+   我们的应用使用多个组件，第六章探讨了共享状态的战略，通过 props 向下传递。该章节展示了如何共享`useState`和`useReducer`的更新器和分发函数，以及如何使用`useCallback`钩子创建对函数的不变引用。

+   组件有时依赖于函数以某种方式生成或转换数据。如果这些函数执行时间相对较长，你只想在绝对必要时调用它们。第七章展示了如何利用`useMemo`钩子来限制昂贵函数的运行时机。

+   有时相同的州值被应用中的许多组件广泛使用。第八章解释了如何使用 React 的 Context API 和`useContext`钩子来共享状态，而无需通过多个组件层级传递 props。

+   React Hooks 只是函数。你可以将调用 hooks 的代码移动到组件外部的函数中。这些函数，或自定义 hooks，可以然后在组件之间和项目之间共享。第九章解释了为什么以及如何创建自定义 hooks，并提供了大量示例，同时强调了 Hooks 规则。

+   流行的 React 库已更新以支持 hooks。第十章利用了 React Router 的第三方 hooks 来管理 URL 中的状态，以及 React Query 来无缝同步你的 UI 与存储在服务器上的状态。

第二部分解释了如何更有效地加载大型应用的组件代码，并使用`Suspense`组件和错误边界来组织资源加载时的后备 UI。然后深入实验性 API，用于将数据加载与 Suspense 集成并在并发模式中工作：

+   第十一章讨论了代码拆分，结合`React.lazy`进行组件的懒加载，`Suspense`组件在组件懒加载时显示后备 UI，以及错误边界在出现问题时显示后备 UI。

+   在第十二章中，我们进入更实验性的领域，探讨图书馆如何将数据获取和图像加载与 Suspense 结合。

+   最后，在第十三章中，我们探讨了只在并发模式下工作的某些易变 API。`useTransition` 和 `useDeferredValue` 钩子和 `SuspenseList` 组件都是为了改善你的应用程序在状态变化期间的用户体验而设计的。它们的确切工作方式仍在变化，但本章为你提供了关于它们试图解决的问题的提示。

虽然本书的主要示例应用程序是在本书的整个过程中构建起来的，但如果你想要直接跳到某个特定的章节或钩子，你不会有任何问题。如果你想运行单个代码示例，你可以查看相应的仓库分支，然后从那里开始。

这些章节还包括练习，以练习刚刚提出的思想。它们主要要求你在示例应用程序的一页上复制另一页上的方法。例如，本书可能展示了如何更新 Bookables 页面，然后要求你为 Users 页面做同样的操作。通过代码实践是许多人的有效学习策略，但如果你需要，你始终可以从仓库中查看解决方案代码。

### 关于代码

本书包含一个持续进行的示例，一个预订应用程序，我们从一章到另一章构建它。这个示例为讨论 React 钩子和观察它们在实际操作中提供了很好的背景。但本书的重点是钩子，而不是预订应用程序，因此，尽管应用程序的大部分代码都在书中，但一些更新的列表可在示例应用程序的 GitHub 仓库中找到，但书中没有展示。该仓库位于 [`github.com/jrlarsen/react-hooks-in-action`](https://github.com/jrlarsen/react-hooks-in-action)。当需要查看最新更改时，我会指出。示例应用程序的开发里程碑在仓库中的单独分支上。

一些简短的示例也不是主要预订应用程序的一部分。它们的代码要么在 CodeSandbox 上（针对基于 React 的示例），要么在 JS Bin 上（针对纯 JavaScript 示例）。书中的代码列表包括指向 GitHub、CodeSandbox 或 JS Bin 的链接，视情况而定。

所有示例都使用 React 17.0.1 进行了彻底的测试。第十三章是一个例外；它使用 React 的实验性发布版本，因此其示例不保证与该仓库分支上使用的版本以外的任何版本兼容。

本书包含许多源代码示例，无论是编号列表还是与普通文本混排。在这两种情况下，源代码都使用 `fixed-width font` `like` `this` 格式化，以将其与普通文本区分开来。有时代码也会用粗体显示，以突出显示章节中从先前步骤更改的代码，或者因为它是周围讨论的重点。

在某些情况下，原始源代码已被重新格式化；我们添加了换行符并重新调整了缩进，以适应书籍中的可用页面空间。在极少数情况下，即使这样也不够，列表中还包括了行续符（➥）。此外，当代码在文本中描述时，源代码中的注释通常已从列表中删除。许多列表旁边都有代码注释，突出显示重要概念。

### liveBook 讨论论坛

购买《React Hooks in Action》包括免费访问由 Manning Publications 运营的私人网络论坛，您可以在那里对书籍发表评论、提出技术问题，并从作者和其他用户那里获得帮助。要访问论坛，请访问[`livebook.manning.com/book/react-hooks-in-action/discussion`](https://livebook.manning.com/book/react-hooks-in-action/discussion)。您还可以在[`livebook.manning.com/#!/discussion`](https://livebook.manning.com/#!/discussion)了解更多关于 Manning 的论坛和行为准则。

Manning 对我们读者的承诺是提供一个场所，在那里个人读者之间以及读者与作者之间可以进行有意义的对话。这不是对作者参与特定数量活动的承诺，作者对论坛的贡献仍然是自愿的（且未支付报酬）。我们建议您尝试向作者提出一些挑战性的问题，以免他的兴趣转移！只要书籍在印刷中，论坛和先前讨论的存档将可通过出版商的网站访问。

### 其他在线资源

官方 React 文档位于[`reactjs.org`](https://reactjs.org/)，这是一份详尽、文笔良好的资源，目前正在重写中。绝对值得一读。本书的页面[www.manning.com/books/react-hooks-in-action](http://www.manning.com/books/react-hooks-in-action)也有一些文章扩展了某些部分和想法。

## 关于作者

约翰·拉森自 1980 年代开始编程，最初使用 Commodore VIC-20 上的 BASIC 语言，后来转向 Java、PHP、C#和 JavaScript。他是《用 JavaScript 编程入门》一书的作者，该书也由 Manning 出版。在英国担任数学教师 25 年，他教授高中生计算机课程，并开发了基于网络的程序，以支持学校的教学、学习和沟通。最近，约翰在日本教授英语，并努力提高自己的日语水平。

## 关于封面插图

《React Hooks in Action》封面上的女性形象被标注为“卡里亚女子”，或称“来自卡里亚的女性”。这幅插图取自雅克·Grasset de Saint-Sauveur（1757-1810）的作品集，名为《不同国家的服饰》，于 1797 年在法国出版。每一幅插图都是手工精心绘制和着色的。Grasset de Saint-Sauveur 收藏中的丰富多样性生动地提醒我们，仅仅 200 年前，世界的城镇和地区在文化上有多么不同。人们彼此孤立，说着不同的方言和语言。在街道或乡村，仅凭他们的服饰就能轻易识别他们居住的地方以及他们的职业或社会地位。

自那以后，我们的着装方式发生了变化，当时地区间的多样性已经消失。现在，很难区分不同大陆、城镇、地区或国家的人们。也许我们用文化多样性换取了更加多样化的个人生活——当然，是为了更加多样化且节奏更快的技术生活。

在难以区分一本计算机书籍与另一本的时候，曼宁通过书籍封面上的设计，庆祝了计算机行业的创新和进取精神。这些设计基于两百年前丰富多样的地区生活，通过 Grasset de Saint-Sauveur 的画作得以重现。
