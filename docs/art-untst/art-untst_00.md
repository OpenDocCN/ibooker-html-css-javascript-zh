# 前言

## 第二版序言

那年一定是 2009 年。我在奥斯陆的挪威开发者大会上发表演讲。（啊，六月的奥斯陆！）活动在一个巨大的体育场馆举行。会议组织者将看台分成了几个区域，在它们前面搭建了舞台，并用厚厚的黑色布料覆盖起来，以创造八个不同的会议“房间”。我记得我差不多结束了我的演讲，内容是关于 TDD、SOLID、天文学，或者诸如此类的东西，突然，从我旁边的舞台上传来了大声而嘈杂的唱歌和弹吉他声。

遮帘如此之厚，以至于我能够透过它们看到我旁边舞台上的那个人，他正在制造所有的噪音。当然，那是 Roy Osherove。

现在，那些了解我的人知道，在关于软件的技术演讲中突然唱歌，是我可能会做的事情，如果心情来了。所以当我转身回到我的观众时，我想，这位 Osherove 先生是一个志同道合的人，我必须更好地了解他。

而去更好地了解他，正是我所做的事情。事实上，他为我的最新著作《Clean Coder》做出了重大贡献，并花三天时间与我共同教授 TDD 课程。我与 Roy 的经历都非常积极，希望还有更多。

我预测，你在阅读这本书的过程中，对 Roy 的经验也会非常积极，因为这本书是特别的。

你读过 Michener 的小说吗？我没有；但有人告诉我，它们都是从“原子”开始的。你手中的这本书不是 James Michener 的小说，但它确实是从“原子”——单元测试的原子开始的。

当你翻阅早期页面时，不要被误导。这不仅仅是一本关于单元测试的介绍。它确实是从介绍开始的，如果你有经验，可以快速浏览那些前几章。随着书的进展，章节开始相互构建，形成了一个相当惊人的深度积累。确实，当我读到最后一章（并不知道那是最后一章）时，我想，下一章可能会讨论世界和平——因为，我的意思是，在解决了将单元测试引入固执的、拥有老旧遗留系统的组织的问题之后，你还能去哪里呢？

这本书是技术性的——非常技术性。有很多代码。这是好事。但 Roy 并不局限于技术。时不时地，他会拿出吉他，在讲述他过去职业生活中的趣事或哲学地讨论设计的意义或*集成*的定义时即兴唱歌。他似乎很喜欢用他 2006 年深远的黑暗过去中的一些糟糕经历来娱乐我们。

哦，对了，不要过于担心代码都是用 C#编写的。我的意思是，谁又能区分 C#和 Java 的区别呢？对吧？而且，这根本不重要。他可能用 C#作为传达意图的工具，但本书中的教训也适用于 Java、C、Ruby、Python、PHP 或其他任何编程语言（也许除了 COBOL）。

如果你是一个单元测试和测试驱动开发的初学者，或者如果你已经是一个老手，你会发现这本书对你有所助益。所以准备好享受罗伊为你演唱的“单元测试的艺术”这首歌曲吧。

罗伊，请调好那把吉他！

——罗伯特·C·马丁（Uncle Bob）

[cleancoder.com](http://cleancoder.com)

## 第一版序言

当罗伊·奥斯霍夫（Roy Osherove）告诉我他正在写一本关于单元测试的书时，我非常高兴地听到了这个消息。测试这一概念在业界已经流行多年，但关于单元测试的资料相对匮乏。当我看看我的书架，我看到的是关于特定测试驱动开发（test-driven development）的书籍和关于一般测试的书籍，但直到现在，还没有一本关于单元测试的全面参考书——没有一本书能介绍这个主题并指导读者从第一步到广泛接受的最佳实践。这个事实令人震惊。单元测试并不是一项新实践。我们是如何到达这个地步的？

说到我们工作在一个非常年轻的行业，这几乎成了一种陈词滥调，但这是真的。数学家们不到 100 年前为我们奠定了基础，但我们只有 60 年来才有足够的硬件来利用他们的洞察力。在我们行业中，理论与实践之间存在一个初始差距，而我们现在才刚刚发现它对我们领域的影响。

在早期，机器周期非常昂贵。我们以批处理的方式运行程序。程序员有一个预定的时间段，他们必须将程序输入到卡片堆中，然后步行到机房。如果你的程序不正确，你就浪费了时间，所以你用铅笔和纸检查你的程序，在脑海中考虑所有的情况，所有的边缘情况。我怀疑自动单元测试的概念甚至无法想象。为什么要在测试时使用机器，而你可以用它来解决它本来要解决的问题呢？稀缺性让我们处于黑暗之中。

后来，机器变得更快，我们沉溺于交互式计算。我们只需输入代码，就可以随心所欲地更改它。桌面检查代码的想法逐渐消失，我们失去了一些早期年份的纪律。我们知道编程很难，但这只是意味着我们必须花更多的时间在电脑前，更改行和符号，直到找到那个神奇的咒语，让它工作。

我们从稀缺到过剩，错过了中间地带，但现在我们正在重新获得它。自动化单元测试将桌面检查的纪律与对计算机作为开发资源的全新认识相结合。我们可以用我们开发的语言编写自动化测试来检查我们的工作——不仅一次，而且只要我们能够运行它们。我认为在软件开发中没有任何其他实践具有如此强大的效果。

当我写这篇东西的时候，在 2009 年，我很高兴看到罗伊的书出版。这是一本实用的指南，它将帮助你开始，并在你进行测试任务时作为一个很好的参考。*单元测试的艺术*不是一本关于理想化场景的书。它教你如何测试实际存在的代码，如何利用广泛使用的框架，最重要的是，如何编写易于测试的代码。

*单元测试的艺术*是一个重要的标题，它本应该在几年前就写成，但我们当时还没有准备好。我们现在准备好了。享受吧。

——迈克尔·费舍斯

对象导师

## 前言

我参与过的最大的失败项目之一有单元测试。或者我以为是这样。我领导着一组程序员创建一个计费应用程序，我们完全采用测试驱动的方式——编写测试，然后编写代码，看到测试失败，让测试通过，重构，然后从头开始。

项目的前几个月进展顺利。一切都很顺利，我们有测试证明了我们的代码是有效的。但随着时间的推移，需求发生了变化。我们被迫改变我们的代码以适应那些新的需求，当我们这样做的时候，测试失败了，不得不修复。代码仍然有效，但我们编写的测试如此脆弱，以至于我们代码的任何微小变化都会使它们失败，尽管代码本身运行良好。在类或方法中更改代码变成了一项艰巨的任务，因为我们还必须修复所有相关的单元测试。

更糟糕的是，一些测试变得无法使用，因为编写它们的那些人离开了项目，没有人知道如何维护测试或它们在测试什么。我们给单元测试方法取的名字不够清晰，我们有一些测试依赖于其他测试。我们在项目开始不到六个月的时候就抛弃了大部分测试。

这个项目是一个悲惨的失败，因为我们让我们所编写的测试带来的伤害大于好处。它们在维护和理解上花费的时间比它们在长期为我们节省的时间要多，所以我们停止了使用它们。我转向了其他项目，在这些项目中，我们编写单元测试做得更好，并且在使用它们时取得了一些巨大的成功，节省了大量调试和集成时间。自从那个失败的项目以来，我一直整理单元测试的最佳实践，并在后续的项目中使用它们。我在每个项目上都能找到一些新的最佳实践。

理解如何编写单元测试，以及如何使它们易于维护、可读和可信，是本书的主题，无论您使用哪种语言或集成开发环境。本书涵盖了编写单元测试的基础知识，进而转向交互测试的基础，并介绍了在现实世界中编写、管理和维护单元测试的最佳实践。

—罗伊·奥斯休维

当 Manning 邀请我帮助完成一本即将完成的关于单元测试的书时，我最初的反应是拒绝。毕竟，我已经有了一本关于单元测试的书，为什么还要参与别人的项目呢？但是当我意识到这本书正是罗伊的《单元测试的艺术》时，我的想法改变了。作为《单元测试的艺术》第一版的读者之一，这本书帮助塑造了我对单元测试的看法。我为能参与这部重要作品的第三版感到荣幸。

我个人认为，这本书是关于单元测试主题的优秀入门书籍。一旦您完成它并准备好深入研究，请拿起我的书，《单元测试原则、实践和模式》（Manning，2020）。

—弗拉基米尔·科里科夫

## 致谢

我们要感谢许多手稿审阅者，他们的反馈帮助我们改进了本书。感谢阿布杜·萨马杜·萨雷、阿迪尔·拉姆吉瓦安、阿德里安·贝尔特茨、阿兰·洛姆波、巴纳比·诺曼、查尔斯·兰姆、康纳·雷德蒙德、达乌特·莫里纳、埃斯雷夫·德恩纳、福斯特·海因斯、哈里纳特·马莱帕利、贾里德·邓肯、贾森·黑尔斯、豪梅·洛佩斯、杰里米·陈、乔尔·霍姆斯、约翰·拉森、乔纳森·里夫斯、乔治·E·博、肯特·斯皮尔纳、金·加布里埃尔森、马塞尔·范登布林克、马克·格雷厄姆、马特·范·温克尔、马泰奥·巴蒂斯塔、马泰奥·吉尔多内、迈克·霍尔科姆、奥利弗·科滕、奥诺弗雷·乔治、保罗·罗布、帕布洛·埃雷拉·J、帕特里斯·马尔达格、拉胡尔·莫德普尔、拉尼特·萨海、里奇·扬茨、理查德·梅森、罗德里戈·恩卡纳斯、罗纳德·博尔曼、萨钦·辛吉、萨曼莎·伯克、桑德·泽格尔德、萨特杰·库马尔·萨胡、谢恩·科尔维尔、塔尼亚·威尔克、汤姆·马登、乌迪特·布拉德瓦杰、瓦迪姆·图尔科夫。

一本成功的书籍的诞生需要许多人的共同努力。我们想要感谢 Manning 的收购编辑迈克尔·斯蒂普斯、开发编辑康纳·奥布赖恩、技术发展编辑迈克·谢泼德、技术校对员让-弗朗索瓦·莫林，以及审阅编辑阿德里安娜·萨博和邓雅·尼科托维奇。我们还要感谢 Manning 的其他所有人，他们在第三版的生产和幕后工作中付出了努力。

最后，我要向在 Manning 早期访问计划中阅读本书的早期读者表示感谢，他们在在线论坛上的评论帮助塑造了本书。您们的帮助对本书的完善至关重要。

## 关于本书

我听说过的关于学习的最聪明的事情之一（我忘了是谁说的）是，要真正学会某样东西，就去教授它。撰写这本书的第一版并在 2009 年出版，对我来说是一次真正的学习体验。我最初写这本书是因为我厌倦了反复回答同样的问题。但还有其他原因。我想尝试新事物；我想尝试一个实验；我想知道写一本书——任何一本书——我能学到什么。我认为我擅长单元测试。诅咒在于，你经验越多，感觉越愚蠢。

第一版中有些内容，我现在并不认同——例如，一个*单元*指的是一个方法。这完全不对。单元是一个工作单元，正如我在本版第三版的第一章中讨论的那样。它可以小到只是一个方法，也可以大到几个类（可能是程序集），还有其他一些变化，你将在下一章了解到。

### 第三版的新内容

在本版第三版中，我们从.NET 切换到了 JavaScript 和 TypeScript。当然，所有相关的工具和框架也得到了更新。例如，我们不再使用 NUnit 测试运行器和 NSubstitute，而是使用了 Jest，它既是一个单元测试框架，也是一个模拟库。

我们在关于在组织层面实施单元测试的章节中增加了更多技术。

在书中展示的代码中，有很多设计上的变化。它们大多与动态类型语言（如 JavaScript）的使用相关，但我们也借助 TypeScript 讨论了静态类型技术。

关于测试可信度、可维护性和可读性的讨论已经扩展到三个单独的章节。我们还增加了一个关于测试策略的新章节：如何在不同测试类型之间做出决定以及使用哪些技术。

### 应该阅读这本书的人

这本书是为任何编写代码并对学习单元测试最佳实践感兴趣的人而写的。所有示例都使用 JavaScript 和 TypeScript 编写，因此 JavaScript 开发者会发现这些示例特别有用。但我们所教授的教训同样适用于大多数，如果不是所有面向对象和静态类型语言（例如 C#、VB.NET、Java 和 C++等）。如果你是架构师、开发者、团队领导、QA 工程师（编写代码的人）或新手程序员，这本书应该非常适合你。

### 本书组织结构：路线图

如果你从未编写过单元测试，最好从头到尾阅读这本书，以便获得全面了解。如果你有经验，你应该可以舒适地根据需要跳转到章节。本书分为四个部分。

第一部分将带您从零开始学习编写单元测试。第一章和第二章涵盖了基础知识，例如如何使用测试框架（Jest），并介绍了自动化测试的概念，如测试库、断言库和测试运行器。它们还介绍了断言、忽略测试、工作单元测试以及单元测试的三个类型的结果，以及为这些结果所需的三个类型的测试：值测试、基于状态的测试和交互测试。

第二部分讨论了打破依赖的高级技术：模拟对象、存根、隔离框架以及重构代码以使用它们的模式。第三章介绍了存根的概念，并展示了如何手动创建和使用它们。第四章介绍了使用模拟对象的交互测试。第五章将这两个概念合并，展示了隔离框架如何结合这两个想法并使它们自动化。第六章深入探讨了如何测试异步代码。

第三部分是关于如何组织测试代码、运行和重构其结构的模式，以及编写测试时的最佳实践。第七章讨论了编写可信赖测试的技术。第八章讨论了单元测试中的最佳实践，以创建可维护的测试。

第四部分全部关于如何在组织中实施变更以及如何处理现有代码。第九章是关于测试可读性的。第十章展示了如何制定测试策略。第十一章讨论了在尝试将单元测试引入组织时可能遇到的问题和解决方案，并识别并回答了您在实施此类努力过程中可能会被问到的一些问题。第十二章讨论了将单元测试引入遗留代码。它确定了确定开始测试位置的一两种方法，并讨论了一些用于测试不可测试代码的工具。

附录列出了您可能在测试工作中发现有用的猴子补丁技术。

### 代码约定和下载

列表中或文本中的所有源代码都使用类似于这样的`固定宽度字体`来区分它们与普通文本。在列表中，`**粗体代码**`表示与上一个示例相比已更改或将在下一个示例中更改的代码。在许多列表中，代码都有注释来指出关键概念。

您可以从 GitHub 在[`github.com/royosherove/aout3-samples`](https://github.com/royosherove/aout3-samples)下载本书的源代码，也可以从出版社的网站[`www.manning.com/books/the-art-of-unit-testing-third-edition`](https://www.manning.com/books/the-art-of-unit-testing-third-edition)下载。您还可以从本书的在线（liveBook）版本中获取可执行的代码片段，网址为[`livebook.manning.com/book/the-art-of-unit-testing-third-edition`](https://livebook.manning.com/book/the-art-of-unit-testing-third-edition)。

### 软件需求

要使用本书中的代码，您需要 VS Code（它是免费的）。您还需要 Jest（一个开源和免费的框架）以及其他将在相关位置引用的工具。所有提到的工具都是免费、开源的，或者您可以在阅读本书时免费试用。所有工具都将在您阅读本书时免费使用。

### liveBook 讨论论坛

购买《单元测试艺术，第三版》包括对 liveBook 的免费访问，这是曼宁的在线阅读平台。使用 liveBook 的独特讨论功能，您可以在全球范围内或针对特定章节或段落添加评论。为个人做笔记、提出和回答技术问题以及从作者和其他用户那里获得帮助都非常简单。要访问论坛，请访问[`livebook.manning.com/book/the-art-of-unit-testing-third-edition/discussion`](https://livebook.manning.com/book/the-art-of-unit-testing-third-edition/discussion)。您还可以在[`livebook.manning.com/discussion`](https://livebook.manning.com/discussion)了解更多关于曼宁论坛和行为准则的信息。

曼宁对读者的承诺是提供一个场所，让读者之间以及读者与作者之间可以进行有意义的对话。这不是对作者参与特定数量活动的承诺，作者对论坛的贡献仍然是自愿的（且未付费）。我们建议您尝试向他们提出一些挑战性的问题，以免他们的兴趣转移！只要书籍在印刷中，论坛和以前讨论的存档将可通过出版社的网站访问。

### 罗伊·奥谢罗夫的其他项目

罗伊还是《弹性领导：培养自我组织团队》一书的作者，可在[www.manning.com/books/elastic-leadership](http://www.manning.com/books/elastic-leadership)找到，以及《给软件团队领导者的笔记：培养自我组织团队》（Team Agile Publishing，2014 年）。

其他资源：

+   一个与本书相关的团队领导者的博客可在[`5whys.com`](http://5whys.com)找到。

+   罗伊提供的在线视频 TDD 大师班可在[`courses.osherove.com/courses`](https://courses.osherove.com/courses)找到。

+   在[`ArtOfUnitTesting.com`](http://ArtOfUnitTesting.com)和[`Osherove.com/Videos`](http://Osherove.com/Videos)上可找到许多关于单元测试的免费视频。

+   罗伊在全球范围内持续进行培训和咨询。您可以通过[`contact.osherove.com`](http://contact.osherove.com)联系他，以在自己的公司预订培训。

您可以在 X 上关注他 @RoyOsherove。

### 弗拉基米尔·科里科夫的其他项目

弗拉基米尔还是《单元测试原则、实践和模式》一书的作者，您可以在[`www.manning.com/books/unit-testing`](https://www.manning.com/books/unit-testing)找到。

其他资源：

+   一个致力于学习单元测试和领域驱动设计的开发者的博客：[`enterprisecraftsmanship.com/`](https://enterprisecraftsmanship.com/)。

+   Pluralsight 上的视频课程可在[`bit.ly/ps-all`](https://bit.ly/ps-all)找到。

你可以在 X 上关注他 @vkhorikov。

## 关于作者

![Osherove](img/Osherove.png)

Roy Osherove 是 ALT.NET 的原始组织者之一，之前在 Typemock 担任首席架构师。他为全球团队提供关于单元测试和测试驱动开发的咨询和培训，并教导团队领导者如何在[5whys.com](http://5whys.com)上更好地领导。Roy 在@RoyOsherove 上发推文，并在[ArtOfUnitTesting.com](http://ArtOfUnitTesting.com)上有很多关于单元测试的视频。他还可以在[Osherove.com](http://Osherove.com)预订演讲和培训。

![Khorikov](img/Khorikov.png)

Vladimir Khorikov 是微软 MVP、博客作者和 Pluralsight 作者。他从事软件开发工作已超过 10 年，包括指导团队进行单元测试的方方面面。Vladimir 是 Manning 出版的《单元测试：原则、实践和模式》一书的作者，他还撰写了几个流行的博客文章系列和关于单元测试的在线培训课程。他教学风格的最大优势，也是学生经常赞扬的地方，是他倾向于拥有强大的理论背景，然后将这些应用到实际例子中。他的博客在[EnterpriseCraftsmanship.com](http://EnterpriseCraftsmanship.com)。

## 关于封面插图

《单元测试艺术，第三版》封面上的图像是一位“着礼服的日本人”，或称“日本礼仪男子”。这幅插图取自詹姆斯·普里查德的《人类自然史》，这是一本于 1847 年在英国出版的彩色石版画集。我们的封面设计师在旧金山的一家古董店发现了它。

在那些日子里，人们通过他们的服饰就能轻易识别出他们的居住地以及他们的职业或社会地位。曼宁通过基于几个世纪前丰富多样的地域文化的封面设计来庆祝计算机行业的创新精神和主动性，这些文化通过像这一系列这样的图片被重新带回生活。
